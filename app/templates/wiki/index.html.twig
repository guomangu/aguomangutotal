{% extends 'base.html.twig' %}

{% block title %}{{ page.title }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
{% endblock %}

{% block body %}
    
    {# Appel du composant. On passe le titre en attribut. #}
    <twig:WikiCard title="{{ page.title }}" backUrl="/admin">
        
        {% block content %}
            {# Tout ce qui est ici va aller dans le corps de la card #}
            
            {# Si tu as une image de couverture #}
            {% if page.image %}
                <img src="{{ page.image }}" class="w-full h-64 object-cover rounded mb-6 shadow-sm" alt="Cover">
            {% endif %}

            {# Le contenu Trix (HTML) #}
            {# <div class="prose max-w-none">
                {{ page.content|raw }}
            </div> #}

            {# --- LISTE DES ARTICLES ENFANTS --- #}
            <div class="mt-8">
                <h2 class="text-xl font-semibold mb-4">Articles</h2>

                {% if page.articles is empty %}
                    <p class="text-gray-500">Aucun article pour l‚Äôinstant.</p>
                {% else %}
                    <ul class="space-y-3">
                        {% for article in page.articles %}
                            <li class="border border-gray-200 rounded p-3 bg-gray-50">
                                <h3 class="font-semibold text-gray-800">{{ article.title }}</h3>
                                {% if article.image %}
                                    <img src="{{ article.image }}" class="w-full h-48 object-cover rounded mb-3 shadow-sm" alt="">
                                {% endif %}
                                {% if article.content %}
                                    <p class="mt-1 text-gray-700 text-sm">
                                        {{ article.content }}
                                    </p>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>

            {% if isOwner and articleForm is not null %}
                {# --- FORMULAIRE DE CREATION D'ARTICLE (r√©serv√© au propri√©taire) --- #}
                <div class="mt-8 border-t pt-6">
                    <h2 class="text-xl font-semibold mb-4">Ajouter un article</h2>
                    {{ form_start(articleForm) }}
                        <div class="space-y-4">
                            {{ form_row(articleForm.title) }}
                            {{ form_row(articleForm.content) }}
                            {{ form_row(articleForm.imageFile) }}
                        </div>
                        <button class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Enregistrer l‚Äôarticle
                        </button>
                    {{ form_end(articleForm) }}
                </div>
            {% endif %}

            {# --- AGENDA / EMPLOI DU TEMPS --- #}
            <div class="mt-10 border-t pt-6">
                <h2 class="text-xl font-semibold mb-4">Agenda / cr√©neaux disponibles</h2>
                <div id="wiki-calendar" class="mt-4 bg-white rounded shadow p-4"></div>
                <p class="mt-2 text-xs text-gray-500">
                    Clique sur un cr√©neau vert pour r√©server ce cr√©neau.
                </p>
            </div>

            {# --- LISTE DES WIKIS ENFANTS --- #}
            <div class="mt-10 border-t pt-6">
                <h2 class="text-xl font-semibold mb-4">Wikis enfants</h2>

                {% if page.children is empty %}
                    <p class="text-gray-500">Aucun wiki enfant pour l‚Äôinstant.</p>
                {% else %}
                    <ul class="space-y-3">
                        {% for child in page.children %}
                            <li class="border border-gray-200 rounded p-3 bg-gray-50 flex justify-between items-center">
                                <div>
                                    <a href="{{ path('app_wiki_show', {id: child.id}) }}" class="font-semibold text-blue-600 hover:underline">
                                        {{ child.title }}
                                    </a>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>

            {% if isOwner and childWikiForm is not null %}
                {# --- FORMULAIRE DE CREATION DE WIKI ENFANT (r√©serv√© au propri√©taire) --- #}
                <div class="mt-8 border-t pt-6">
                    <h2 class="text-xl font-semibold mb-4">Cr√©er un wiki enfant</h2>
                    {{ form_start(childWikiForm) }}
                        <div class="space-y-4">
                            {{ form_row(childWikiForm.title) }}
                            {{ form_row(childWikiForm.imageFile) }}
                        </div>
                        <button class="mt-4 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                            Cr√©er le wiki enfant
                        </button>
                    {{ form_end(childWikiForm) }}
                </div>
            {% endif %}

            {% if isOwner and agendaForm is not null %}
                {# --- FORMULAIRE DE CREATION DE ROUTINE DE CRENEAUX (plusieurs jours) --- #}
                <div class="mt-8 border-t pt-6">
                    <h2 class="text-xl font-semibold mb-4">Ajouter une routine de cr√©neaux</h2>
                    {{ form_start(agendaForm) }}
                        <div class="space-y-4">
                            {{ form_row(agendaForm.title) }}
                            {{ form_row(agendaForm.startTime) }}
                            {{ form_row(agendaForm.endTime) }}
                            {{ form_row(agendaForm.daysOfWeek) }}
                            {{ form_row(agendaForm.capacity) }}
                        </div>
                        <button class="mt-4 px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                            Enregistrer la routine
                        </button>
                    {{ form_end(agendaForm) }}
                </div>

                {# --- LISTE DES ROUTINES EXISTANTES --- #}
                <div class="mt-8 border-t pt-6">
                    <h2 class="text-xl font-semibold mb-4">Routines existantes</h2>

                    {% set patterns = page.agendaSlotPatterns ?? [] %}

                    {% if patterns is empty %}
                        <p class="text-gray-500 text-sm">Aucune routine pour l‚Äôinstant.</p>
                    {% else %}
                        <table class="min-w-full text-sm text-left border border-gray-200 rounded overflow-hidden">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2">Titre</th>
                                    <th class="px-3 py-2">Jour</th>
                                    <th class="px-3 py-2">Heure</th>
                                    <th class="px-3 py-2">Capacit√©</th>
                                    <th class="px-3 py-2 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pattern in patterns %}
                                    <tr class="border-t border-gray-200">
                                        <td class="px-3 py-2">{{ pattern.title }}</td>
                                        <td class="px-3 py-2">
                                            {% set d = pattern.dayOfWeek %}
                                            {% if d == 1 %}Lundi{% elseif d == 2 %}Mardi{% elseif d == 3 %}Mercredi{% elseif d == 4 %}Jeudi{% elseif d == 5 %}Vendredi{% elseif d == 6 %}Samedi{% else %}Dimanche{% endif %}
                                        </td>
                                        <td class="px-3 py-2">
                                            {{ pattern.startTime|date('H:i') }} ‚Üí {{ pattern.endTime|date('H:i') }}
                                        </td>
                                        <td class="px-3 py-2">{{ pattern.capacity }}</td>
                                        <td class="px-3 py-2 text-right">
                                            <form method="post"
                                                  action="{{ path('app_wiki_pattern_delete', {wikiId: page.id, id: pattern.id}) }}"
                                                  onsubmit="return confirm('Supprimer cette routine ?');">
                                                <input type="hidden" name="_token" value="{{ csrf_token('delete_pattern' ~ pattern.id) }}">
                                                <button class="text-red-500 hover:text-red-700 text-xs font-semibold">
                                                    Supprimer
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% endif %}
                </div>
            {% endif %}

            {% if isOwner %}
                {# --- BOUTON DELETE (r√©serv√© au propri√©taire) --- #}
                <div class="flex justify-end mb-4 mt-6">
                    <form method="post" action="{{ path('app_wiki_delete', {'id': page.id}) }}" onsubmit="return confirm('S√ªr de vouloir supprimer √ßa ?');">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ page.id) }}">
                        <button class="text-red-500 hover:text-red-700 text-sm font-bold underline">
                            Supprimer cette page üóëÔ∏è
                        </button>
                    </form>
                </div>
            {% endif %}
        {% endblock %}

    </twig:WikiCard>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const calendarEl = document.getElementById('wiki-calendar');
            if (!calendarEl) return;

            const wikiId = {{ page.id }};

            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                locale: 'fr',
                timeZone: 'local',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                firstDay: 1,
                allDaySlot: false,
                slotMinTime: '06:00:00',
                slotMaxTime: '22:00:00',
                events: function (info, successCallback, failureCallback) {
                    const params = new URLSearchParams({
                        start: info.startStr,
                        end: info.endStr,
                        filters: JSON.stringify({ wikiId: wikiId })
                    });

                    fetch('/fc-load-events?' + params.toString())
                        .then(response => {
                            if (response.status === 204) {
                                return '[]';
                            }
                            if (!response.ok) {
                                throw new Error('Erreur lors du chargement des √©v√©nements');
                            }
                            return response.text();
                        })
                        .then(text => text ? JSON.parse(text) : [])
                        .then(events => successCallback(events))
                        .catch(error => {
                            console.error(error);
                            failureCallback(error);
                        });
                }
            });

            calendar.render();
        });
    </script>
{% endblock %}